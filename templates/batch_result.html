<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Batch Prediction Results</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="fade-in">

    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-left">
            <h2>Fraud Detection</h2>
        </div>
        <div class="navbar-right">
            <span class="welcome">Welcome, {{ session['user'] }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger animate-btn">Sign Out</a>
        </div>
    </nav>

    <div class="container">
        <h3>Batch Prediction Results (showing top 50)</h3>
        {% for table in tables %}
        {{ table | safe }}
        {% endfor %}

        {% if roc_data %}
        <h4>ROC Curve</h4>
        <canvas id="rocChart"></canvas>
        <script>
            const ctx = document.getElementById('rocChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: {{ roc_data.fpr | safe }},
                datasets: [{
                    label: 'True Positive Rate',
                    data: {{ roc_data.tpr | safe }},
                borderColor: 'blue',
                borderWidth: 2,
                fill: false,
                tension: 0.1
                    }]
                },
                options: {
                responsive: true,
                plugins: {
                    legend: { display: true },
                    tooltip: { enabled: true }
                },
                scales: {
                    x: { title: { display: true, text: 'False Positive Rate' } },
                    y: { title: { display: true, text: 'True Positive Rate' } }
                }
            }
            });
        </script>
        {% endif %}

        {% if cm_data %}
        <h4>Confusion Matrix</h4>
        <p>
            <strong>TP:</strong> {{ cm_data[1][1] }} |
            <strong>FP:</strong> {{ cm_data[0][1] }} |
            <strong>TN:</strong> {{ cm_data[0][0] }} |
            <strong>FN:</strong> {{ cm_data[1][0] }}
        </p>

        <canvas id="cmChart" width="400" height="400"></canvas>
        <script>
            const cmCtx = document.getElementById('cmChart').getContext('2d');
            new Chart(cmCtx, {
                type: 'bar',
                data: {
                    labels: ['Predicted Negative', 'Predicted Positive'],
                    datasets: [
                        {
                            label: 'Actual Negative',
                            data: [{{ cm_data[0][0] }}, {{ cm_data[0][1] }}],
                backgroundColor: [
                    'rgba(0, 200, 83, 0.6)',   // TN green
                    'rgba(255, 193, 7, 0.6)'   // FP yellow
                ]
            },
                {
                    label: 'Actual Positive',
                    data: [{{ cm_data[1][0] }}, {{ cm_data[1][1] }}],
                backgroundColor: [
                'rgba(244, 67, 54, 0.6)',  // FN red
                'rgba(33, 150, 243, 0.6)'  // TP blue
            ]
                        }
                    ]
                },
                options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Confusion Matrix (Visualized)',
                        font: { size: 16 }
                    },
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function (ctx) {
                                return ctx.dataset.label + ': ' + ctx.formattedValue;
                            }
                        }
                    }
                },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true, precision: 0 }
                }
            }
            });
        </script>
        {% endif %}

        <a href="{{ url_for('home') }}" class="btn btn-outline-primary animate-btn">Back to Home</a>
    </div>

</body>

</html>